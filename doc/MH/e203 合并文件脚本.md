# 脚本简介：

+ 路径：`vsim/mergefile_nice.py`;

+ 将蜂鸟`e203`的整个`soc`系统合并为一个名为`e203_soc_top`的文件，并且删除文件起始处含有`config.v`/`e203_defines.v`/`i2c_master_defines.v`定义；同时按照`iEDA`中`interfered.md`修改蜂鸟`e203`中模块名字。

# 脚本测试：

## 原蜂鸟e203 SoC测试

为了测试合并文件后的正确性，首先在蜂鸟e203内部环境测试，使用e203_tb。此脚本并不会修改蜂鸟e203内部逻辑，因此可以验证脚本以及生成文件的正确性。

+ 修改`vsim/Makefile`：将`make install`命令下复制 e203_soc代码替代为执行mergefile_nice.py脚本；

```
install: 
    @mkdir -p ${SIM_DIR}/install/tb
    @mkdir -p ${SIM_DIR}/install/rtl
#    @cp ${SIM_DIR}/../tb/*.v ${SIM_DIR}/install/tb -rf
#    @cp ${SIM_DIR}/../rtl/${core_name} ${SIM_DIR}/install/rtl -rf
    @python3 ./mergefile_nice.py
```

- 执行`make compile`进行编译测试；
- 执行`make run_test`将会执行`add`测试集；
- 执行`make wave`查看对应波形文件；

注意：`e203_tb`仅用于在`e203`项目中测试`e203_soc_top.v`的正确性，在接入`AXI`总线接口后需要外接`AXI4_slave`，否则无法测试；

## 添加`ICB2AXI`后的蜂鸟e203测试：

### 修改：

+ 添加文件：`e203/rtl/e203/soc/e203_soc_axi_top.v`/`e203/rtl/e203/soc/sirv_expi_axi_slv.v`

+ 修改`tb_top.v`文件，将顶层文件改为`e203_soc_axi_top`；

```
# 合并测试台文件
with open('./install/tb/tb_top.v', 'w') as tb:
    tb.write(open(E203con).read())
    tb.write(e203def)
    for path in tbFiles:
        with open(path) as f:
            content = f.read()
            content = content.replace('`include "e203_defines.v"', "")

            tb.write(content)
    logging.info('TB is ok')
```

### 步骤：

1. 修改后的蜂鸟e203 SoC工程，因为顶层含有`AXI4`接口，因此无法继续使用e203_tb文件验证其功能正确性。

2. 但可以在总文件`e203_soc_top.v`外面再套一层`e203_soc_axi_top.v`，使其`AXI4`接口在内部接入`sirv_expi_axi_slv.v`，从而得到一个不含`AXI4`接口的顶层模块，可以继续使用蜂鸟e203测试接入`AXI4`端口的正确性

## 修改后的蜂鸟e203接入iEDA

在`Makefile`中添加`make ysyx`，可以将修改后的`e203_soc.v`与`ysyx/ysyx_e203.v`合并为`ysyx_e203.v`，并将其复制到`iverilog-soc/cpu`目录中

`make ysyx IEDA=‘请修改相对应iverilog-soc目录’`
